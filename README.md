### About
Корневой репозиторий для запуска системы продьюсер <-> брокер сообщений <-> консьюмер. 

* Продьюсер - Product API, который при создании нового продукта берет из DTO адрес лендинга товара и отправляет его в брокер на проверку
* Брокер сообщений - RabbitMQ
* Консьюмер - приложение на Go, которое подключается к брокеру, получает оттуда адреса для проверки и, если адрес недоступен, отправляет их в очередь на повторную проверку

Описание решения смотри [ниже](#описание-решения).

### Как запустить
Система сервисов запускается через [`Docker`](https://docs.docker.com/get-docker/) (вернее, `docker-compose`)

Для развертывания необходимо:
1. Выкачать данный репозиторий и перейти в него
2. Выкачать продьюсера и консьюмера
3. Запустить систему контейнеров
```
git clone https://github.com/egorkartashov/xbes-rabbitmq-root.git
cd xbes-rabbitmq-root

git clone https://github.com/egorkartashov/xbes-rabbitmq-consumer.git
git clone https://github.com/egorkartashov/xsolla-school-backend-2021-test.git
cd xsolla-school-backend-2021-test
git checkout -m dev/rabbitmq
cd ..

docker-compose up -d
```

### Описание решения
1. При выполнении POST /products запроса продьюсер отправляет url в виде `text/plain` сообщения в первую очередь (`check-url-queue`) RabbitMQ
2. Консьюмер получает из очереди `check-url-queue` и проверяет доступность адреса
3. Если адрес недоступен, то консьюмер отправляет адрес на повторную проверку в другую очередь - `retry-check-url-queue`. При этом отправка выполняется [с задержкой (aka `x-delay`](https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq).
4. Консьюмер параллельно выкачивает адреса из второй очереди и проверяет их тоже.
5. Чтобы адреса не проверялись до бесконечности, у сообщения с адресом есть заголовок `ttl`, который изначально задается продьюсером и уменьшается на 1 перед каждой отправкой консьюмером на перепроверку. Когда `ttl` доходит до `0`, консьюмер не отправляет адрес на перепроверку.

Результаты работы коньюсмера можно посмотреть по логам соответствюущего контейнера (контейнер `url-checker`)

